!function(r){"use strict";function e(r,e,n){this.message=e||"",this.code=r||-32e3,Boolean(n)&&(this.data=n)}var n=Promise;if(void 0===n&&(n=r.Promise),void 0===n)throw"Promise is not supported! Use latest version node/browser or promise-polyfill";var t=function(r){return void 0===r},o=Array.isArray,s=function(r){var e=typeof r;return null!=r&&("object"==e||"function"==e)},i=function(r){return"function"==typeof r},a=function(r){return"string"==typeof r},u=function(r){if(s(r)){for(var e in r)if(r.hasOwnProperty(e))return!1;return!0}return o(r)?!r.length:!r},c=function(r,e){if(o(r))return r.map(e);for(var n in r)r.hasOwnProperty(n)&&e(r[n])},f=function(r){return JSON.parse(JSON.stringify(r))},d={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};e.prototype=new Error;var p=function(){function r(r,n){var t=f(r);return n&&(s(n)&&n.hasOwnProperty("message")?t.data=n.message:a(n)&&(t.data=n),n instanceof e&&(t={message:n.message,code:n.code},n.hasOwnProperty("data")&&(t.data=n.data))),t}function p(r){return!!r&&"function"==typeof r.then}function m(r){return!!r.error}function l(r){return!!r.method}function h(r){return r.hasOwnProperty("result")&&r.hasOwnProperty("id")}function v(r){var e=[];return o(r)?c(r,function(r){e.push(y(r))}):s(r)&&e.push(y(r)),n.all(e).then(function(r){var e=[];return c(r,function(r){t(r)||e.push(r)}),1===e.length?w.toStream(JSON.stringify(e[0])):e.length>1&&w.toStream(JSON.stringify(e)),r})}function y(e){try{return m(e)?O(e):h(e)?g(e):l(e)?N(e):n.resolve({id:null,jsonrpc:"2.0",error:r(d.INVALID_REQUEST)})}catch(r){return n.reject(r)}}function O(r){P.hasOwnProperty(r.id)&&P[r.id].reject(r.error)}function g(r){P.hasOwnProperty(r.id)&&(P[r.id].resolve(r.result),delete P[r.id])}function N(e){if(!E.hasOwnProperty(e.method))return n.resolve({jsonrpc:"2.0",id:e.id,error:r(d.METHOD_NOT_FOUND,{message:e.method})});try{var i;if(e.hasOwnProperty("params")){if("pass"==E[e.method].params)i=E[e.method].fn.call(E,e.params);else if(o(e.params))i=E[e.method].fn.apply(E,e.params);else if(s(e.params)){if(!(E[e.method].params instanceof Array))return n.resolve({jsonrpc:"2.0",id:e.id,error:r(d.INVALID_PARAMS,"Undeclared arguments of the method "+e.method)});var a=[];if(E[e.method].params.forEach(function(r){e.params.hasOwnProperty(r)?(a.push(e.params[r]),delete e.params[r]):a.push(void 0)}),Object.keys(e.params).length>0)return n.resolve({jsonrpc:"2.0",id:e.id,error:r(d.INVALID_PARAMS,{message:"Params: "+Object.keys(e.params).toString()+" not used"})});i=E[e.method].fn.apply(E,a)}}else i=E[e.method].fn();return e.hasOwnProperty("id")?p(i)?i.then(function(r){return t(r)&&(r=!0),{jsonrpc:"2.0",id:e.id,result:r}}).catch(function(n){return{jsonrpc:"2.0",id:e.id,error:r(d.INTERNAL_ERROR,n)}}):(t(i)&&(i=!0),n.resolve({jsonrpc:"2.0",id:e.id,result:i})):n.resolve()}catch(t){return n.resolve({jsonrpc:"2.0",id:e.id,error:r(d.INTERNAL_ERROR,t)})}}function S(r,e){var n={jsonrpc:"2.0",method:r,params:e};return s(e)&&!u(e)&&(n.params=e),n}function R(r,e){j+=1;var t={jsonrpc:"2.0",method:r,id:j};return s(e)&&!u(e)&&(t.params=e),{promise:new n(function(r,e){P[j.toString()]={resolve:r,reject:e}}),message:t}}var w=this,P={},j=0,E={};w.toStream=function(r){throw new Error("No toStream function defined")},w.dispatch=function(r,e,n){if(a(r)&&"pass"==e&&i(n))E[r]={fn:n,params:e};else if(a(r)&&o(e)&&i(n))E[r]={fn:n,params:e};else{if(!(a(r)&&i(e)&&t(n)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");E[r]={fn:e,params:null}}},w.on=w.dispatch,w.off=function(r){delete E[r]},w.call=function(r,e){var n=R(r,e);return w.toStream(JSON.stringify(n.message)),n.promise},w.notification=function(r,e){w.toStream(JSON.stringify(S(r,e)))},w.batch=function(r){var e=[],t=[];return c(r,function(r){if(r.hasOwnProperty("call")){var n=R(r.call.method,r.call.params);t.push(n.message),e.push(n.promise.then(function(r){return r},function(r){return r}))}else r.hasOwnProperty("notification")&&t.push(S(r.notification.method,r.notification.params))}),w.toStream(JSON.stringify(t)),n.all(e)},w.messageHandler=function(r){try{return v(JSON.parse(r))}catch(r){return w.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:d.PARSE_ERROR})),n.reject(r)}},w.customException=function(r,n,t){return new e(r,n,t)}};if("function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return p});else if("undefined"!=typeof module&&void 0!==module.exports)module.exports=p;else{if(void 0===r)return p;r.simple_jsonrpc=p}}(this);